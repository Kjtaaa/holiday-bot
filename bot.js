const { Bot } = require("grammy");
const cron = require("node-cron");
const fs = require("fs");
require('dotenv').config();

const BOT_TOKEN = process.env.BOT_TOKEN;

const bot = new Bot(BOT_TOKEN);

// --- –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ ---
const HOLIDAYS_FILE = "holidays.json";
const USERS_FILE = "users.json";

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∞–∑–¥–Ω–∏–∫–∏
let holidays = {};
try {
  const data = fs.readFileSync(HOLIDAYS_FILE, "utf8");
  holidays = JSON.parse(data);
  console.log("‚úÖ –°–ø–∏—Å–æ–∫ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω");
} catch (err) {
  console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ holidays.json:", err);
  process.exit(1);
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–º–∞—Å—Å–∏–≤ chat_id)
let users = [];
try {
  const data = fs.readFileSync(USERS_FILE, "utf8");
  users = JSON.parse(data);
  console.log(`üë• –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`);
} catch (err) {
  // –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –∏–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π, —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
  users = [];
  fs.writeFileSync(USERS_FILE, JSON.stringify(users, null, 2));
  console.log("üìÅ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª users.json");
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ñ–∞–π–ª
function saveUsers() {
  fs.writeFileSync(USERS_FILE, JSON.stringify(users, null, 2));
}

// –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç
function addUser(chatId) {
  if (!users.includes(chatId)) {
    users.push(chatId);
    saveUsers();
    console.log(`‚ûï –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω: ${chatId}`);
  }
}

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –±–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)
function removeUser(chatId) {
  const index = users.indexOf(chatId);
  if (index !== -1) {
    users.splice(index, 1);
    saveUsers();
    console.log(`‚ûñ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω: ${chatId}`);
  }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM-DD
function getTodayKey() {
  const now = new Date();
  const month = String(now.getMonth() + 1).padStart(2, "0");
  const day = String(now.getDate()).padStart(2, "0");
  return `${month}-${day}`;
}

// ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î =====

// –ö–æ–º–∞–Ω–¥–∞ /start ‚Äì –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
bot.command("start", async (ctx) => {
  const chatId = ctx.chat.id;
  addUser(chatId); // –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É

  await ctx.reply(
    "–ü—Ä–∏–≤–µ—Ç! üëã\n–Ø –±–æ—Ç-–ø–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 10 —É—Ç—Ä–∞ —è –±—É–¥—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–±–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –ø—Ä–∞–∑–¥–Ω–∏–∫, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –¥–æ–±—Ä–æ–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ.\n\n" +
    "–¢—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É /check, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –µ—Å—Ç—å –ª–∏ —Å–µ–≥–æ–¥–Ω—è –ø—Ä–∞–∑–¥–Ω–∏–∫ –ø–æ –º–æ–µ–º—É —Å–ø–∏—Å–∫—É.\n\n" +
    "–ß—Ç–æ–±—ã –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç —Ä–∞—Å—Å—ã–ª–∫–∏, –æ—Ç–ø—Ä–∞–≤—å –∫–æ–º–∞–Ω–¥—É /stop."
  );
});

// –ö–æ–º–∞–Ω–¥–∞ /stop ‚Äì —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ä–∞—Å—Å—ã–ª–∫–∏
bot.command("stop", async (ctx) => {
  const chatId = ctx.chat.id;
  removeUser(chatId);
  await ctx.reply("–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π. –ß—Ç–æ–±—ã —Å–Ω–æ–≤–∞ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è, –≤–≤–µ–¥–∏—Ç–µ /start.");
});

// –ö–æ–º–∞–Ω–¥–∞ /check ‚Äì —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞
bot.command("check", async (ctx) => {
  const todayKey = getTodayKey();
  const chatId = ctx.chat.id;
  addUser(chatId); // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Ç–æ–∂–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ –±–∞–∑–µ

  if (holidays[todayKey]) {
    await ctx.reply(`–°–µ–≥–æ–¥–Ω—è: –° ${holidays[todayKey]}`);
  } else {
    const fallback = [
      "–°–µ–≥–æ–¥–Ω—è –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ –Ω–µ—Ç, –Ω–æ –¥–µ–Ω—å –≤—Å—ë —Ä–∞–≤–Ω–æ —Ö–æ—Ä–æ—à–∏–π! üòâ",
      "–û–±—ã—á–Ω—ã–π –¥–µ–Ω—å, –Ω–æ –≤—ã —Å–¥–µ–ª–∞–π—Ç–µ –µ–≥–æ –æ—Å–æ–±–µ–Ω–Ω—ã–º! ‚ú®",
      "–ù–µ—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–∞? –ù–µ –±–µ–¥–∞ ‚Äì –ø–æ–¥–∞—Ä–∏—Ç–µ —Ä–∞–¥–æ—Å—Ç—å —Å–µ–±–µ —Å–∞–º–∏! üéÅ"
    ];
    const randomIndex = Math.floor(Math.random() * fallback.length);
    await ctx.reply(fallback[randomIndex]);
  }
});

// (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ö–æ–º–∞–Ω–¥–∞ /stats –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
bot.command("stats", async (ctx) => {
  // –û–≥—Ä–∞–Ω–∏—á–∏–º –¥–æ—Å—Ç—É–ø, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞ (—É–∫–∞–∂–∏—Ç–µ —Å–≤–æ–π ID)
  const adminId = 123456789; // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π ID
  if (ctx.chat.id === adminId) {
    await ctx.reply(`üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: ${users.length}`);
  } else {
    await ctx.reply("–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
  }
});

// ===== –ï–ñ–ï–î–ù–ï–í–ù–ê–Ø –†–ê–°–°–´–õ–ö–ê =====

async function sendDailyGreeting() {
  const todayKey = getTodayKey();
  let greeting;

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
  if (holidays[todayKey]) {
    greeting = `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è—é —Å ${holidays[todayKey]}`;
  } else {
    const fallbackMessages = [
      "–ñ–µ–ª–∞—é –æ—Ç–ª–∏—á–Ω–æ–≥–æ –¥–Ω—è! ‚òÄÔ∏è",
      "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è —Å–ª—É—á–∏—Ç—Å—è –º–∞–ª–µ–Ω—å–∫–æ–µ —á—É–¥–æ! ‚ú®",
      "–•–æ—Ä–æ—à–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ —É–ª—ã–±–æ–∫! üòä",
      "–° –¥–Ω—ë–º –Ω–æ–≤—ã—Ö –æ—Ç–∫—Ä—ã—Ç–∏–π! üîç",
      "–ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –ø—Ä–∏–Ω–µ—Å—ë—Ç —É–¥–∞—á—É! üçÄ",
      "–° –¥–Ω—ë–º, –ø–æ–ª–Ω—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π! üåü",
      "–ü—É—Å—Ç—å –≤—Å—ë –∑–∞–¥—É–º–∞–Ω–Ω–æ–µ —Å–±—É–¥–µ—Ç—Å—è! üí´",
      "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ–≥–æ –≤–∞–º –¥–Ω—è! üå∫",
      "–£–ª—ã–±–Ω–∏—Ç–µ—Å—å, —Å–µ–≥–æ–¥–Ω—è –≤–∞—à –¥–µ–Ω—å! üòÑ",
      "–ü—É—Å—Ç—å –¥–µ–Ω—å –±—É–¥–µ—Ç –ª—ë–≥–∫–∏–º –∏ —Ä–∞–¥–æ—Å—Ç–Ω—ã–º! üåà"
    ];
    const randomIndex = Math.floor(Math.random() * fallbackMessages.length);
    greeting = fallbackMessages[randomIndex];
  }

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  for (const chatId of users) {
    try {
      await bot.api.sendMessage(chatId, greeting);
      console.log(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${chatId}: ${greeting}`);
    } catch (err) {
      console.error(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${chatId}:`, err.description || err.message);
      // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å —Ç–µ–º, —á—Ç–æ –±–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ —á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —É–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (err.error_code === 403 || err.error_code === 400) {
        removeUser(chatId);
      }
    }
  }
}

// –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 9:00 —É—Ç—Ä–∞ (–≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞)
cron.schedule("1 0 * * *", () => {
  console.log("‚è∞ –ó–∞–ø—É—Å–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏...");
  sendDailyGreeting();
});

// ===== –ó–ê–ü–£–°–ö –ë–û–¢–ê =====
bot.start();
console.log("üöÄ –ë–æ—Ç —Å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ –∑–∞–ø—É—â–µ–Ω...");